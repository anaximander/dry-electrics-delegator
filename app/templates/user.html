{% extends "base.html" %}

{% block header %}
  <title>Dry Electrics Delegator - {{username}}</title>
  <script src="https://d3js.org/d3.v5.min.js"></script>
{% endblock %}

{% block content %}
<body bgcolor="#dddddd">
  <center>
  <h1>{{username}} Charge History</h1>
  <input type="datetime-local" id="start-time">
  <input type="datetime-local" id="end-time">
  <button id="today-button">Today</button>
  <button id="all-button">All</button><br />
  </center>
  <script type="text/javascript">

  function formatDate(dt) {
    return dt.substr(0,10) + "T" + dt.substr(11,5)
  }

  var data = JSON.parse('{{data | safe}}')
  document.getElementById("start-time").value = formatDate(data[0][2])
  document.getElementById("end-time").value = formatDate(data[data.length - 1][2])

  let startTime = document.getElementById("start-time").value
  let endTime = document.getElementById("end-time").value

  var svgWidth = 800;
  var svgHeight = 600;
  var svg = d3.select("center").append("svg").attr("width", svgWidth).attr("height", svgHeight)

  var margin = {top: 10, right: 10, bottom: 50, left: 50};
  var width = +svg.attr("width") - margin.left - margin.right;
  var height = +svg.attr("height") - margin.top - margin.bottom;

  var g = svg.append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  var x = d3.scaleTime()
      .domain([Date.parse(startTime), Date.parse(endTime)])
      .range([0, width]);

  var y = d3.scaleLinear()
      .domain([0, 100])
      .range([height, 0]);

  var xAxisCall = d3.axisBottom(x).tickSize(-height);
  var xAxis = g.append("g")
      .attr("class", "x-axis")
      .attr("transform", "translate(" + 0 + "," + height + ")")
      .call(xAxisCall);

  var yAxisCall = d3.axisLeft(y).tickSize(-width);
  var yAxis = g.append("g")
      .attr("class", "y-axis")
      .call(yAxisCall)

  var circles = g.selectAll("circle").data(data);

  circles.enter().append("circle")
    .attr("cx", function(d){ return x(Date.parse(d[2])) })
    .attr("cy", function(d){ return y(d[0]) })
    .attr("r", 2)
    .attr("fill", "green");


  function updateChart() {
    let startTime = Date.parse(document.getElementById("start-time").value)
    let endTime = Date.parse(document.getElementById("end-time").value)
    x.domain([startTime, endTime])
    xAxisCall = d3.axisBottom(x).tickSize(-height);
    xAxis.call(xAxisCall)

    newData = data.filter(e =>  Date.parse(e[2]) <= endTime && Date.parse(e[2]) >= startTime)

    var newCircles = g.selectAll("circle")
          .remove()
          .exit()
          .data(newData)

    newCircles.enter().append("circle")
    .attr("cx", function(d){ return x(Date.parse(d[2])) })
    .attr("cy", function(d){ return y(d[0]) })
    .attr("r", 2)
    .attr("fill", "green");
  }

  document.getElementById("start-time").addEventListener("change", updateChart)
  document.getElementById("end-time").addEventListener("change", updateChart)
  document.getElementById("all-button").addEventListener("click", function() {
    document.getElementById("start-time").value = formatDate(data[0][2])
    document.getElementById("end-time").value = formatDate(data[data.length - 1][2])
    updateChart()
  })

  document.getElementById("today-button").addEventListener("click", function() {
    let today = new Date()
    let datePrefix = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate();

    document.getElementById("start-time").value = datePrefix+"T09:00"
    document.getElementById("end-time").value = datePrefix+"T18:00"
    updateChart()
  })

  </script>
</body>

{% endblock %}
