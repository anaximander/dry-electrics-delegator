{% extends "base.html" %}

{% block header %}
  <title>Dry Electrics Delegator - {{username}}</title>
  <script src="https://d3js.org/d3.v5.min.js"></script>
{% endblock %}

{% block content %}
<body bgcolor="#dddddd">
  <center>
  <h1>{{username}} Charge History</h1>
  <input type="datetime-local" id="start-time">
  <input type="datetime-local" id="end-time">
  <button id="today-button">Today</button>
  <button id="all-button">All</button><br />
  </center>
  <script type="text/javascript">


  function toHex(num) {
    return (num < 16) ? "0"+num.toString(16) : num.toString(16)
  }

  function getPointColor(percentage) {
    let red, green
    if (percentage <= 50) {
      red = 255
      green = Math.round(255 * percentage * 2 / 100)
    }
    else {
      red = Math.round(255 * (1 - (percentage - 50) * 2 / 100))
      green = 255
    }

    return "#" + toHex(red) + toHex(green) + "00"
  }

  function formatDate(dt) {
    return dt.substr(0,10) + "T" + dt.substr(11,5)
  }

  var data = JSON.parse('{{data | safe}}')
  document.getElementById("start-time").value = formatDate(data[0][2])
  document.getElementById("end-time").value = formatDate(data[data.length - 1][2])

  let startTime = document.getElementById("start-time").value
  let endTime = document.getElementById("end-time").value

  var svgWidth = 800;
  var svgHeight = 600;
  var svg = d3.select("center").append("svg").attr("width", svgWidth).attr("height", svgHeight)

  var margin = {top: 10, right: 10, bottom: 50, left: 50};
  var width = +svg.attr("width") - margin.left - margin.right;
  var height = +svg.attr("height") - margin.top - margin.bottom;

  var g = svg.append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  var x = d3.scaleTime()
      .domain([Date.parse(startTime), Date.parse(endTime)])
      .range([0, width]);

  var y = d3.scaleLinear()
      .domain([0, 100])
      .range([height, 0]);

  var xAxisCall = d3.axisBottom(x).tickSize(-height);
  var xAxis = g.append("g")
      .attr("class", "x-axis")
      .attr("transform", "translate(" + 0 + "," + height + ")")
      .call(xAxisCall);

  var yAxisCall = d3.axisLeft(y).tickSize(-width);
  var yAxis = g.append("g")
      .attr("class", "y-axis")
      .call(yAxisCall)

  var circles = g.selectAll("circle").data(data);



  circles.enter().append("circle")
    .attr("cx", function(d){ return x(Date.parse(d[2])) })
    .attr("cy", function(d){ return y(d[0]) })
    .attr("r", 3)
    .attr("fill", function(d) { return getPointColor(d[0]) })
    .on("mouseover", pointMouseOver)
    .on("mouseout", pointMouseOut)


  function updateChart() {
    let startTime = Date.parse(document.getElementById("start-time").value)
    let endTime = Date.parse(document.getElementById("end-time").value)
    x.domain([startTime, endTime])
    xAxisCall = d3.axisBottom(x).tickSize(-height);
    xAxis.call(xAxisCall)

    newData = data.filter(e =>  Date.parse(e[2]) <= endTime && Date.parse(e[2]) >= startTime)

    var newCircles = g.selectAll("circle")
          .remove()
          .exit()
          .data(newData)

    newCircles.enter().append("circle")
    .attr("cx", function(d){ return x(Date.parse(d[2])) })
    .attr("cy", function(d){ return y(d[0]) })
    .attr("r", 3)
    .attr("fill", function(d) { return getPointColor(d[0]) })
    .on("mouseover", pointMouseOver)
    .on("mouseout", pointMouseOut)
  }

  document.getElementById("start-time").addEventListener("change", updateChart)
  document.getElementById("end-time").addEventListener("change", updateChart)
  document.getElementById("all-button").addEventListener("click", function() {
    document.getElementById("start-time").value = formatDate(data[0][2])
    document.getElementById("end-time").value = formatDate(data[data.length - 1][2])
    updateChart()
  })

  document.getElementById("today-button").addEventListener("click", function() {
    let today = new Date()
    let datePrefix = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate();

    document.getElementById("start-time").value = datePrefix+"T09:00"
    document.getElementById("end-time").value = datePrefix+"T18:00"
    updateChart()
  })

  function pointMouseOver(d, i) {
    d3.select(this)
      .attr("fill", "blue")
      .attr("r", 6)

    svg.append("rect")
      .attr("id", "idrect"+i)
      .attr("x", x(Date.parse(d[2])) - 45)
      .attr("y", y(d[0])-20)
      .attr("width", 200)
      .attr("height", 20)
      .attr("fill", "black")
      .attr("fill-opacity", 0.5)
      .text(function() {
      return d[0]+"% @ "+d[2].substr(0,10) + " " + d[2].substr(11,8)
      })

    svg.append("text")
      .attr("id", "idtext"+i)
      .attr("x", x(Date.parse(d[2])) - 40)
      .attr("y", y(d[0]) - 5)
      .attr("fill", "white")
      .text(function() {
      return d[0]+"% @ "+d[2].substr(0,10) + " " + d[2].substr(11,8)
      })
  }

  function pointMouseOut(d, i) {
    d3.select(this)
      .attr("fill", function(d) { return getPointColor(d[0]) })
      .attr("r", 3)

    d3.select("#idrect"+i).remove()
    d3.select("#idtext"+i).remove()
  }
  </script>
</body>

{% endblock %}
